apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  # multus
  - https://raw.githubusercontent.com/k8snetworkplumbingwg/multus-cni/master/deployments/multus-daemonset-thick.yml
  - install-cni.configmap.yaml

patches:
  # See https://docs.siderolabs.com/kubernetes-guides/cni/multus#patching-the-daemonset
  - patch: |-
      apiVersion: apps/v1
      kind: DaemonSet
      metadata:
        name: kube-multus-ds
        namespace: kube-system
      spec:
        template:
          spec:
            volumes:
              - hostPath:
                  path: /var/run/netns/
                name: host-run-netns
              - name: install-cni
                ConfigMap:
                  name: multus-install-cni
  - patch: |-
      apiVersion: apps/v1
      kind: DaemonSet
      metadata:
        name: kube-multus-ds
        namespace: kube-system
      spec:
        template:
          spec:
            initContainers:
            - command:
                - install-cni.sh
              image: alpine/k8s:1.33.5
              name: install-cni
              securityContext:
                privileged: true
              volumeMounts:
                - mountPath: /host/opt/cni/bin
                  mountPropagation: Bidirectional
                  name: cnibin
                - mountPath: /install-cni.sh
                  name: install-cni
                  subPath: install-cni.sh
